<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Debug - Sorriso</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .check {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #ccc;
        }
        .check.success {
            border-color: #4CAF50;
        }
        .check.error {
            border-color: #f44336;
        }
        .check.warning {
            border-color: #ff9800;
        }
        h1 { color: #001F3F; }
        code {
            background: #eee;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 14px;
        }
        pre {
            background: #eee;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>üîç Diagn√≥stico PWA</h1>
    <div id="results"></div>

    <script>
        const results = document.getElementById('results');

        function addCheck(title, status, message, details = '') {
            const div = document.createElement('div');
            div.className = `check ${status}`;
            div.innerHTML = `
                <h3>${status === 'success' ? '‚úÖ' : status === 'error' ? '‚ùå' : '‚ö†Ô∏è'} ${title}</h3>
                <p>${message}</p>
                ${details ? `<pre>${details}</pre>` : ''}
            `;
            results.appendChild(div);
        }

        // 1. Verificar HTTPS
        if (location.protocol === 'https:' || location.hostname === 'localhost') {
            addCheck('HTTPS', 'success', 'Site est√° sendo servido via HTTPS ou localhost');
        } else {
            addCheck('HTTPS', 'error', 'PWA requer HTTPS em produ√ß√£o!');
        }

        // 2. Verificar Service Worker
        if ('serviceWorker' in navigator) {
            addCheck('Service Worker API', 'success', 'Navegador suporta Service Worker');

            navigator.serviceWorker.getRegistrations().then(registrations => {
                if (registrations.length > 0) {
                    const details = registrations.map(reg =>
                        `Scope: ${reg.scope}\nActive: ${!!reg.active}\nWaiting: ${!!reg.waiting}\nInstalling: ${!!reg.installing}`
                    ).join('\n\n');
                    addCheck('Service Worker Registrado', 'success',
                        `${registrations.length} service worker(s) registrado(s)`, details);
                } else {
                    addCheck('Service Worker Registrado', 'error',
                        'Nenhum service worker registrado ainda');
                }
            });
        } else {
            addCheck('Service Worker API', 'error', 'Navegador n√£o suporta Service Worker');
        }

        // 3. Verificar Manifest
        const manifestLink = document.querySelector('link[rel="manifest"]');
        if (manifestLink) {
            addCheck('Link do Manifest', 'success', `Manifest linkado: ${manifestLink.href}`);

            fetch(manifestLink.href)
                .then(r => r.json())
                .then(manifest => {
                    addCheck('Manifest Carregado', 'success',
                        'Manifest.json carregado com sucesso',
                        JSON.stringify(manifest, null, 2));

                    // Verificar campos obrigat√≥rios
                    const required = ['name', 'icons', 'start_url', 'display'];
                    const missing = required.filter(field => !manifest[field]);

                    if (missing.length === 0) {
                        addCheck('Campos Obrigat√≥rios', 'success',
                            'Todos os campos obrigat√≥rios presentes');
                    } else {
                        addCheck('Campos Obrigat√≥rios', 'error',
                            `Campos faltando: ${missing.join(', ')}`);
                    }

                    // Verificar √≠cones
                    if (manifest.icons && manifest.icons.length > 0) {
                        const has192 = manifest.icons.some(i => i.sizes.includes('192'));
                        const has512 = manifest.icons.some(i => i.sizes.includes('512'));

                        if (has192 && has512) {
                            addCheck('√çcones PWA', 'success',
                                '√çcones 192x192 e 512x512 configurados');
                        } else {
                            addCheck('√çcones PWA', 'warning',
                                `Faltando: ${!has192 ? '192x192 ' : ''}${!has512 ? '512x512' : ''}`);
                        }
                    }
                })
                .catch(err => {
                    addCheck('Manifest Carregado', 'error',
                        `Erro ao carregar manifest: ${err.message}`);
                });
        } else {
            addCheck('Link do Manifest', 'error', 'Tag <link rel="manifest"> n√£o encontrada');
        }

        // 4. Verificar beforeinstallprompt
        let promptReceived = false;
        window.addEventListener('beforeinstallprompt', (e) => {
            promptReceived = true;
            addCheck('beforeinstallprompt', 'success',
                'Evento beforeinstallprompt disparado! O PWA pode ser instalado.');
        });

        setTimeout(() => {
            if (!promptReceived) {
                addCheck('beforeinstallprompt', 'warning',
                    'Evento beforeinstallprompt N√ÉO disparou ainda. Poss√≠veis raz√µes:\n' +
                    '- PWA j√° est√° instalado\n' +
                    '- Falta engajamento do usu√°rio (visitar 2x em 5 min)\n' +
                    '- Algum crit√©rio de instalabilidade n√£o foi atendido\n' +
                    '- Service Worker ainda n√£o est√° ativo');
            }
        }, 3000);

        // 5. Verificar se j√° est√° instalado
        if (window.matchMedia('(display-mode: standalone)').matches) {
            addCheck('Status de Instala√ß√£o', 'success',
                'PWA j√° est√° instalado e rodando em modo standalone!');
        } else {
            addCheck('Status de Instala√ß√£o', 'warning',
                'PWA n√£o est√° instalado (rodando no navegador)');
        }

        // 6. Verificar tema
        const themeColor = document.querySelector('meta[name="theme-color"]');
        if (themeColor) {
            addCheck('Theme Color', 'success', `Theme color definido: ${themeColor.content}`);
        } else {
            addCheck('Theme Color', 'warning', 'Meta tag theme-color n√£o encontrada');
        }
    </script>
</body>
</html>
